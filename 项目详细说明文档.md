# HS Card Plugin Template 项目详细说明

## 项目概述

这是一个基于Hearthstone-Script的卡牌插件模板项目，专门用于开发《炉石传说》卡牌适配插件。该插件主要服务于MCTS策略，为特定的奥秘法卡组提供卡牌行为适配支持。

- **项目名称**: mystery-mage-plugin (奥秘法卡牌插件)
- **作者**: 玄
- **版本**: 1.0.0
- **仓库地址**: https://github.com/Xuan-BOMS/hs-card-plugin-template

## 技术栈与依赖

### 开发环境要求
- **Java版本**: JDK 21+
- **构建工具**: Maven 3.x
- **编程语言**: Kotlin
- **目标平台**: Hearthstone-Script v4.11.0-GA

### 主要依赖
- **策略SDK**: hs-script-strategy-sdk (版本由父项目定义)
- **卡牌SDK**: hs-script-card-sdk (版本由父项目定义)
- **父项目**: Hearthstone-Script hs-script v4.11.0-GA

## 项目结构详解

```
hs-card-plugin-template/
├── pom.xml                     # Maven项目配置文件
├── README.md                   # 项目说明文档
├── LICENSE                     # GPL3.0开源协议
├── LICENSE1                    # 禁止商用附加协议
└── src/
    └── main/
        ├── kotlin/             # Kotlin源代码目录
        │   └── club/
        │       └── xiaojiawei/
        │           └── cardplugintemplate/
        │               ├── TemplatePlugin.kt    # 插件配置类
        │               ├── TarCreeper.kt       # 示例卡牌类
        │               └── cards/              # 卡牌实现目录
        │                   ├── AncientMysteries.kt
        │                   ├── AnimatedAvalanche.kt
        │                   ├── Anonymous.kt
        │                   ├── ArcaneFlakmage.kt
        │                   ├── AstralVigilant.kt
        │                   ├── ContractConjurer.kt
        │                   ├── Counterspell.kt
        │                   ├── CrystalSmith.kt
        │                   ├── EliteTaurenChieftain.kt
        │                   ├── FlameWard.kt
        │                   ├── FlustemechanicRatchet.kt
        │                   ├── GrandFinale.kt
        │                   ├── HasStonebrew.kt
        │                   ├── IceBarrier.kt
        │                   ├── Nerubian.kt
        │                   ├── Objection.kt
        │                   ├── Orion.kt
        │                   ├── Polymorph.kt
        │                   ├── RiggedFaireGame.kt
        │                   ├── SirFinleyMrrgglton.kt
        │                   └── WildfireWoodlands.kt
        ├── resources/          # 资源文件目录
        │   └── META-INF/
        │       └── services/  # 服务注册文件
        │           ├── club.xiaojiawei.hsscriptcardsdk.CardPlugin
        │           └── club.xiaojiawei.hsscriptcardsdk.CardAction
        └── resources-filtered/ # 过滤资源文件目录
            └── club/
                └── xiaojiawei/
                    └── cardplugintemplate/
                        └── VersionInfo.java  # 版本信息模板
```

## 核心组件说明

### 1. 插件配置类 (TemplatePlugin.kt)

```kotlin
class TemplatePlugin : CardPlugin {
    override fun description(): String = "奥秘法"
    override fun author(): String = "玄"
    override fun version(): String = VersionInfo.VERSION
    override fun id(): String = "11451430"
    override fun name(): String = "30奥秘法"
    override fun homeUrl(): String = "https://github.com/Xuan-BOMS/hs-card-plugin-template"
    override fun cardSDKVersion(): String? = VersionInfo.CARD_SDK_VERSION_USED
    override fun strategySDKVersion(): String? = VersionInfo.STRATEGY_SDK_VERSION_USED
    override fun pluginScope(): Array<String> = PluginScope.PUBLIC
}
```

该类是插件的主配置类，定义了插件的基本信息：
- **描述**: 插件功能说明
- **作者**: 开发者信息
- **版本**: 当前插件版本
- **ID**: 插件唯一标识符
- **名称**: 插件显示名称
- **SDK版本**: 依赖的SDK版本信息

### 2. 卡牌适配类

每个卡牌类都继承自`CardAction.DefaultCardAction()`，实现特定的卡牌行为逻辑。以`TarCreeper.kt`为例：

```kotlin
class TarCreeper : CardAction.DefaultCardAction() {
    override fun triggerTurnStart(war: War) {
        // 回合开始时触发效果
        findSelf(war)?.let { card ->
            if (card.area.player === war.currentPlayer) {
                card.atc -= 2
            }
        }
    }

    override fun triggerTurnEnd(war: War) {
        // 回合结束时触发效果
        findSelf(war)?.let { card ->
            if (card.area.player === war.currentPlayer) {
                card.atc += 2
            }
        }
    }

    override fun createNewInstance(): CardAction = TarCreeper()
    override fun getCardId(): Array<String> = cardIds
}
```

### 3. 服务注册机制

插件通过Java SPI（Service Provider Interface）机制进行注册：

**CardPlugin注册** (`src/main/resources/META-INF/services/club.xiaojiawei.hsscriptcardsdk.CardPlugin`):
```
club.xiaojiawei.cardplugintemplate.TemplatePlugin
```

**CardAction注册** (`src/main/resources/META-INF/services/club.xiaojiawei.hsscriptcardsdk.CardAction`):
```
club.xiaojiawei.cardplugintemplate.TarCreeper
club.xiaojiawei.cardplugintemplate.cards.AstralVigilant
club.xiaojiawei.cardplugintemplate.cards.SirFinleyMrrgglton
// ... 其他卡牌类
```

### 4. Maven配置详解

#### 基本配置
- **Group ID**: com.github.Xuan-BOMS
- **Artifact ID**: mystery-mage-plugin
- **Version**: 1.0.0
- **Parent**: Hearthstone-Script hs-script v4.11.0-GA

#### 仓库配置
```xml
<repositories>
    <repository>
        <id>mavenCentral</id>
        <url>https://repo1.maven.org/maven2/</url>
    </repository>
    <repository>
        <id>jitpack.io</id>
        <url>https://jitpack.io</url>
    </repository>
</repositories>
```

#### 构建配置
- **源代码目录**: src/main/kotlin
- **资源目录**: src/main/resources 和 src/main/resources-filtered
- **最终名称**: ${project.artifactId}
- **Java版本**: 21
- **Kotlin编译目标**: JVM 21

#### 版本信息生成
项目使用Maven resources plugin在构建时自动生成版本信息类，将pom.xml中的版本变量注入到VersionInfo.java中。

## 打包和测试流程

### 环境准备

1. **安装JDK 21+**
   ```bash
   # 验证Java版本
   java -version
   ```

2. **安装Maven 3.x**
   ```bash
   # 验证Maven版本
   mvn --version
   ```

### 打包流程

#### 方法一：使用IDE打包
1. 在IntelliJ IDEA中打开项目
2. 右键点击项目根目录
3. 选择 "Maven" -> "Lifecycle" -> "package"
4. 或者使用Maven工具窗口执行package命令

#### 方法二：命令行打包
```bash
# 清理并打包
mvn clean package

# 或者跳过测试打包
mvn clean package -DskipTests

# 详细日志打包
mvn clean package -X
```

#### 打包输出
打包完成后，生成的JAR文件位于：
```
target/mystery-mage-plugin.jar
```

### 测试流程

#### 单元测试
```bash
# 运行所有测试
mvn test

# 运行特定测试类
mvn test -Dtest=ClassName

# 运行特定测试方法
mvn test -Dtest=ClassName#methodName
```

#### 集成测试
```bash
# 运行集成测试
mvn verify

# 跳过测试的完整构建
mvn clean install -DskipTests
```

### 调试和开发流程

#### 开发模式调试
1. **作为子模块开发**（推荐）：
   ```bash
   # 在Hearthstone-Script根目录执行
   git submodule add <你的仓库地址> user-card-plugins/你的项目名
   ```

2. **修改父项目配置**：
   - 在`Hearthstone-Script/pom.xml`的`modules`标签中添加你的模块
   - 在`hs-script-app/pom.xml`的`dependencies`标签中添加插件依赖

3. **直接运行测试**：
   ```bash
   # 在Hearthstone-Script根目录执行
   mvn clean test
   ```

#### 生产部署
1. 打包生成JAR文件
2. 将生成的`mystery-mage-plugin.jar`复制到Hearthstone-Script软件根目录的`plugin`文件夹下
3. 重启Hearthstone-Script应用程序

## 开发指南

### 添加新卡牌

1. **创建卡牌类**：
   ```kotlin
   // src/main/kotlin/club/xiaojiawei/cardplugintemplate/cards/NewCard.kt
   class NewCard : CardAction.DefaultCardAction() {
       override fun createNewInstance(): CardAction = NewCard()
       override fun getCardId(): Array<String> = arrayOf("CARD_ID")

       // 实现卡牌特定逻辑
       override fun triggerPlay(war: War) {
           // 卡牌使用时的逻辑
       }
   }
   ```

2. **注册卡牌**：
   在`src/main/resources/META-INF/services/club.xiaojiawei.hsscriptcardsdk.CardAction`文件中添加：
   ```
   club.xiaojiawei.cardplugintemplate.cards.NewCard
   ```

### 修改插件信息

编辑`TemplatePlugin.kt`类中的相应方法：
- 修改`description()`更新插件描述
- 修改`name()`更新插件名称
- 修改`id()`更新插件唯一标识

### 版本管理

版本信息通过Maven管理，修改`pom.xml`中的版本号：
```xml
<version>1.0.1</version>
```

## 常见问题与解决方案

### 1. Maven构建失败

**问题**: 找不到依赖或构建失败
**解决方案**:
```bash
# 清理Maven缓存
mvn clean

# 强制更新依赖
mvn clean package -U

# 检查网络连接和仓库配置
```

### 2. Java版本不匹配

**问题**: 编译时提示Java版本不兼容
**解决方案**:
```bash
# 检查当前Java版本
java -version

# 确保使用JDK 21+
# 设置JAVA_HOME环境变量
export JAVA_HOME=/path/to/jdk21
```

### 3. 卡牌ID不匹配

**问题**: 卡牌效果不触发
**解决方案**:
- 确认卡牌ID是否正确（可从炉石传说维基获取）
- 检查卡牌类是否已正确注册
- 验证插件是否被正确加载

### 4. 插件无法加载

**问题**: 插件在Hearthstone-Script中无法识别
**解决方案**:
- 检查SPI注册文件是否正确
- 确认JAR文件完整性
- 验证依赖版本兼容性

## 协议信息

本项目遵循双重协议：
1. **GPL3.0开源协议** - 允许自由使用、修改和分发
2. **禁止商用附加协议** - 禁止将此插件用于商业用途

详细协议内容请参考项目根目录下的LICENSE和LICENSE1文件。

## 相关资源

- **Hearthstone-Script主项目**: https://github.com/xjw580/Hearthstone-Script
- **卡牌SDK**: https://github.com/xjw580/hs-script-card-sdk
- **策略SDK**: https://github.com/xjw580/hs-script-strategy-sdk
- **基础插件模板**: https://github.com/xjw580/hs-script-base-card-plugin
- **MCTS策略**: https://github.com/xjw580/hs-script-base-strategy-plugin

## 技术支持

如需技术支持或遇到问题，可以：
1. 查阅相关SDK文档
2. 参考基础插件模板实现
3. 在GitHub仓库中提交Issue
4. 参与社区讨论和交流